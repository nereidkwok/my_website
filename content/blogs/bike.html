---
categories:
- ""
- ""
date: "2017-11-31T22:42:51-05:00"
description: Hello, this is Nereid. I am a Master of Analytics and Management student at London Business School.
draft: false
image: picbike.jpeg
keywords: ""
slug: bike
title: Excess rentals in TfL bike sharing
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>Download the latest TfL data on how many bikes were hired every single day.</p>
<pre class="r"><code>url &lt;- &quot;https://data.london.gov.uk/download/number-bicycle-hires/ac29363e-e0cb-47cc-a97a-e216d900a6b0/tfl-daily-cycle-hires.xlsx&quot;

# Download TFL data to temporary file
httr::GET(url, write_disk(bike.temp &lt;- tempfile(fileext = &quot;.xlsx&quot;)))</code></pre>
<pre><code>## Response [https://airdrive-secure.s3-eu-west-1.amazonaws.com/london/dataset/number-bicycle-hires/2021-08-23T14%3A32%3A29/tfl-daily-cycle-hires.xlsx?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=AKIAJJDIMAIVZJDICKHA%2F20210919%2Feu-west-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20210919T083508Z&amp;X-Amz-Expires=300&amp;X-Amz-Signature=27b3fde46dddd1b83e09b35e430768b14a3bf8acf9dff1f78d09bb9431a603ff&amp;X-Amz-SignedHeaders=host]
##   Date: 2021-09-19 08:35
##   Status: 200
##   Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
##   Size: 173 kB
## &lt;ON DISK&gt;  C:\Users\User\AppData\Local\Temp\RtmpU3KEbb\file469017b2368c.xlsx</code></pre>
<pre class="r"><code># Use read_excel to read it as dataframe
bike0 &lt;- read_excel(bike.temp,
                   sheet = &quot;Data&quot;,
                   range = cell_cols(&quot;A:B&quot;))

# change dates to get year, month, and week
bike &lt;- bike0 %&gt;% 
  clean_names() %&gt;% 
  rename (bikes_hired = number_of_bicycle_hires) %&gt;% 
  mutate (year = year(day),
          month = lubridate::month(day, label = TRUE),
          week = isoweek(day))</code></pre>
<p>Facet grid plots of bikes hired by month and year.</p>
<p><img src="/img/tfl_distributions_monthly.png" width="100%" /></p>
<blockquote>
<p>May and Jun in 2020 are significantly different compared to the previous years. This might be due to COVID, under which most people tend to transit less away from home, and employees usually work from home rather than to work at office.</p>
</blockquote>
<p>Below 2 graphs showcase the difference between the expected number of rentals per week/month between 2016-2019 and then, see how each week/month of 2020-2021 compares to the expected rentals.</p>
<p>Mean rather than median will be used to calculate your expected rentals, since we would like the whole picture of the specific week or month.</p>
<p>Graph of monthly change in Tfl bike rentals, displaying changes from monthly average shown in Blue and calculated between 2016-2019.</p>
<pre class="r"><code># Filter 2016 to 2019 data
expected_monthly &lt;- bike%&gt;%
  filter(day &gt;= dmy(&quot;01/01/2016&quot;), day&lt;dmy(&quot;01/01/2020&quot;))%&gt;%
  # Expected monthly average grouped by month derived from 2016-2019 data
  group_by(month)%&gt;%
  summarise(expected_avg = mean(bikes_hired))

# Filter all data after 2016
monthly_rentals &lt;- bike%&gt;%
  filter(day &gt;= dmy(&quot;01/01/2016&quot;))%&gt;%
  # Actual monthly average for the months
  group_by(year,month) %&gt;% 
  summarise(actual_avg=mean(bikes_hired)) %&gt;% 
  # Join expected average and actual average
  left_join(expected_monthly, by = &quot;month&quot;)</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;year&#39;. You can override using the `.groups` argument.</code></pre>
<pre class="r"><code># Plot the monthly changes in Tfl bike rentals
monthly_rentals %&gt;% 
  ggplot(aes(x=as.numeric(month)))+
  # Indicate the expected average in blue
  geom_line(aes(y=expected_avg),color=&quot;blue&quot;)+
  geom_line(aes(y=actual_avg),color = &quot;black&quot;)+
  # Using geom_ribbon 
  # to create green shades for higher than expected average data
  # and red shades for lower than expected average data
  geom_ribbon(aes(ymin=expected_avg, ymax=pmax(actual_avg,expected_avg)),fill=&quot;springgreen1&quot;, alpha = 0.3) +
  geom_ribbon(aes(ymin=pmin(actual_avg,expected_avg), ymax=expected_avg), fill=&quot;tomato&quot;, alpha = 0.3)+
  # faceted by year
  facet_wrap(~year)+
  theme_bw()+
  # Formatting with adjustment
  theme(legend.position = &quot;none&quot;,
        strip.background = element_blank(),
        panel.border = element_blank(),
        plot.title = element_text(size = 9),
        plot.subtitle = element_text(size = 7),
        strip.text.x = element_text(size = 5),
        axis.text.y = element_text(size = 5),
        axis.text.x = element_text(size = 5))+
  # Format x axis month names
  scale_x_continuous(labels = function(x) month.abb[x])+
  # Add title and axis labels
  labs(title = &quot;Monthly change in Tfl bike rentals&quot;,
       subtitle = &quot;Change from monthly average shown in Blue and calculated between 2016-2019&quot;,
       x = &quot;Month&quot;,
       y = &quot;Bikes rentals&quot;)</code></pre>
<p><img src="/blogs/bike_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>Graph of percentage changes from the expected level of weekly rentals. The two grey shaded rectangles correspond to Q2 (weeks 14-26) and Q4 (weeks 40-52).</p>
<pre class="r"><code># Filter 2016 to 2019 data, 
# starting first day of week and endding last day of week
expected_weekly &lt;- bike %&gt;% 
  filter(day&gt;=dmy(&quot;4/1/2016&quot;) &amp; day&lt;=dmy(&quot;29/12/2019&quot;)) %&gt;% 
  # Expected weekly average grouped by month derived from 2016-2019 data
  group_by(week) %&gt;% 
  summarise(expected_rentals=mean(bikes_hired))

# Filter 2016 and onwards data, starting first day of week
weekly_rentals &lt;- bike %&gt;% 
  filter(day&gt;dmy(&quot;4/1/2016&quot;)) %&gt;% 
  group_by(year,week) %&gt;%
  # Adjust current year data that falls on last week of prior year
  mutate(yearminusone = year - 1,
         year_week = ifelse(week==53 &amp; month==&quot;Jan&quot;,
                            paste(yearminusone,week,sep=&quot;-&quot;),
                            paste(year,week,sep=&quot;-&quot;))) %&gt;%
  group_by(year_week) %&gt;%
  # Actual monthly average for the months
  mutate(actual_rentals = mean(bikes_hired)) %&gt;% 
  # Filter one data for each week
  filter(day==max(day)) %&gt;%
  ungroup() %&gt;%
  # Join expected average and actual average
  left_join(expected_weekly,by =c(&quot;week&quot;)) %&gt;% 
  # calculate the percentage changes
  mutate(delta=(actual_rentals/expected_rentals- 1),
         delta = replace_na(delta, 1),
         month=ifelse(week==53,&quot;Dec&quot;,month),
         year=ifelse(week==53,year-1,year)) %&gt;% 
  add_row(year=2016,week=53,delta=0)

# Graph weekly rentals plot
weekly_rentals %&gt;% 
  ggplot(aes(x=week,
             y=delta))+
  geom_line(aes(y = delta)) +
  # Create grey rectangular backgrounds for Q2 and Q4
  annotate(&quot;rect&quot;, xmin = 13, xmax = 26, ymin = -Inf, ymax = Inf, fill = &quot;grey&quot;, alpha = 0.3)+
  annotate(&quot;rect&quot;, xmin = 39, xmax = 53, ymin = -Inf, ymax = Inf, fill = &quot;grey&quot;, alpha = 0.3)+
  # Using geom_ribbon 
  # to create green shades for higher than expected average data
  # and red shades for lower than expected average data
  geom_ribbon(aes(ymin=0, ymax=pmax(0, delta), fill=&quot;tomato&quot;, alpha = 0.3)) +
  geom_ribbon(aes(ymin=pmin(0, delta), ymax=0, fill=&quot;springgreen1&quot;, alpha = 0.3))+
  # Add rug marks on the x axis with the indicative green/red rugs.
  geom_rug(data=subset(weekly_rentals,delta&gt;=0),color=&quot;springgreen1&quot;,sides=&quot;b&quot;)+
  geom_rug(data=subset(weekly_rentals,delta&lt;0),color=&quot;tomato&quot;,sides=&quot;b&quot;)+
  # Facet by year
  facet_wrap(~year)+
  # Set y axis as percentage
  scale_y_continuous(labels = scales::percent)+
  # set x axis to display the last week of the quarters
  scale_x_continuous(breaks = c(13,26,39,53))+
  # Label title and axis
  labs(title=&quot;Weekly changes in TfL bike rentals&quot;,
       subtitle=&quot;% change from weekly averages \ncalculated between 2016-2019&quot;,
       x=&quot;week&quot;,
       y=&quot;&quot;)+
  theme_bw()+
  # Formatting with adjustment
  theme(legend.position = &quot;none&quot;,
        strip.background = element_blank(),
        panel.border = element_blank(),
        plot.title = element_text(size = 9),
        plot.subtitle = element_text(size = 7),
        strip.text.x = element_text(size = 5),
        axis.text.y = element_text(size = 5),
        axis.text.x = element_text(size = 5))</code></pre>
<p><img src="/blogs/bike_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
